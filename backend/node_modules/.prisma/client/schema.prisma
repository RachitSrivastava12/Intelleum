// ================================
// Prisma Schema – MEV Intelligence
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------------
// Block-level data
// --------------------
model Block {
  slot            BigInt @id
  blockTime       Int?
  leaderValidator String
  txCount         Int

  transactions Transaction[]

  @@index([leaderValidator])
}

// --------------------
// Transactions
// --------------------
model Transaction {
  signature   String  @id
  slot        BigInt
  feeLamports BigInt
  success     Boolean
  signer      String
  priorityFee BigInt?

  block        Block         @relation(fields: [slot], references: [slot])
  instructions Instruction[]

  @@index([slot])
  @@index([signer])
}

// --------------------
// Instructions
// --------------------
model Instruction {
  id               BigInt   @id @default(autoincrement())
  txSignature      String
  instructionIndex Int
  programId        String
  accounts         String[]
  computeUnits     Int?

  transaction Transaction @relation(fields: [txSignature], references: [signature])

  @@index([programId])
  @@index([txSignature])
}

// --------------------
// Wallets
// --------------------
model Wallet {
  address       String @id
  firstSeenSlot BigInt
  lastSeenSlot  BigInt

  mevEntityId String?
  mevEntity   MevEntity? @relation(fields: [mevEntityId], references: [id], onDelete: SetNull)

  @@index([mevEntityId])
}

// --------------------
// MEV Entities
// --------------------
model MevEntity {
  id               String  @id
  walletCount      Int
  firstSeenSlot    BigInt
  avgLatencyMs     Float?
  feeAggression    Float? // avg priority fee ratio
  dominantStrategy String?

  wallets         Wallet[]
  entityPoolStats EntityPoolStat[]

  @@index([dominantStrategy])
}

// --------------------
// Strategies
// --------------------
model Strategy {
  id             String @id
  triggerType    String // large_swap, liquidity_change
  executionShape String // pre_victim_post, backrun
  atomicity      String // full, partial
  avgProfit      Float?
  successRate    Float?

  @@index([triggerType])
}

// --------------------
// Liquidity Pools
// --------------------
model Pool {
  address      String @id
  protocol     String // Raydium, Orca, Jupiter
  tokenA       String
  tokenB       String
  liquidityUsd Float?

  entityPoolStats EntityPoolStat[]

  @@index([protocol])
}

// --------------------
// Entity ↔ Pool Stats
// --------------------
model EntityPoolStat {
  id          BigInt @id @default(autoincrement())
  entityId    String
  poolAddress String

  executions    Int
  profitUsd     Float
  firstSeenSlot BigInt
  lastSeenSlot  BigInt

  mevEntity MevEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  pool      Pool      @relation(fields: [poolAddress], references: [address], onDelete: Cascade)

  @@index([poolAddress])
  @@index([entityId])
}

// --------------------
// Validators
// --------------------
model Validator {
  identity       String   @id
  slotsLed       Int
  mevCapturedUsd Float?
  dominantPools  String[]

  @@index([slotsLed])
}
